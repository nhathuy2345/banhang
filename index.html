<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Shop ƒêi·ªán C∆° 247</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
/* ===== GI·ªÆ NGUY√äN CSS C·ª¶A B·∫†N (KH√îNG ƒê·ªîI) ===== */
*{box-sizing:border-box}
body{margin:0;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;min-height:100vh;color:#e2e8f0;background:#0f172a;display:flex;justify-content:center;line-height:1.6}
body::before{content:"";position:fixed;inset:0;background:radial-gradient(circle at 20% 20%,rgba(59,130,246,.1),transparent 40%),radial-gradient(circle at 80% 80%,rgba(251,191,36,.1),transparent 40%);z-index:-1}
.container{max-width:1200px;width:100%;padding:40px 20px;display:grid;grid-template-columns:1.6fr 1fr;gap:30px}
@media(max-width:900px){.container{grid-template-columns:1fr}}
h1{grid-column:1/-1;color:#fbbf24;text-align:center;font-size:2.5rem;margin-bottom:10px}
.card{background:rgba(30,41,59,.7);backdrop-filter:blur(10px);border-radius:20px;padding:24px;position:relative;border:1px solid rgba(255,255,255,.05);box-shadow:0 15px 35px rgba(0,0,0,.4);height:fit-content}
.card::after{content:"";position:absolute;top:-1px;left:20%;right:20%;height:2px;background:linear-gradient(90deg,transparent,#fbbf24,transparent);box-shadow:0 0 15px #fbbf24}
h2{color:#fbbf24;font-size:1.4rem;margin-top:0;border-bottom:1px solid rgba(255,255,255,.1);padding-bottom:10px}
.product-item{background:rgba(15,23,42,.4);padding:15px;border-radius:12px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center;border:1px solid rgba(255,255,255,.03);transition:.3s}
.product-item:hover{transform:translateX(5px);background:rgba(15,23,42,.8)}
table{width:100%;border-collapse:collapse}
td{padding:10px 5px;border-bottom:1px solid rgba(255,255,255,.05)}
.total-price{font-size:1.2rem;color:#fbbf24;font-weight:bold;text-align:right;margin-top:15px}
input{width:100%;padding:12px 15px;margin:10px 0;border-radius:10px;border:1px solid #334155;background:#0f172a;color:white}
button{padding:12px 20px;border-radius:10px;border:none;cursor:pointer;font-weight:bold}
.btn-add{background:#fbbf24;color:#000}
.btn-confirm{width:100%;background:linear-gradient(135deg,#fbbf24,#f59e0b);color:#1c1917;font-size:1.1rem;margin-top:15px}
#qr{margin-top:25px;padding:20px;background:rgba(255,255,255,.05);border-radius:15px;text-align:center;display:none;border:1px dashed #fbbf24}
.qr-img-wrapper{background:white;padding:15px;border-radius:10px;display:inline-block}
</style>
</head>

<body>
<div class="container">
<h1>Shop ƒêi·ªán C∆° 247</h1>

<div class="card">
<h2>üì¶ Danh s√°ch thi·∫øt b·ªã</h2>
<div id="productList">ƒêang t·∫£i...</div>
</div>

<div>
<div class="card">
<h2>üõí Gi·ªè h√†ng</h2>
<div id="cartList">Ch∆∞a c√≥ s·∫£n ph·∫©m.</div>
<div id="totalArea" class="total-price" style="display:none"></div>
</div>

<div class="card">
<h2>üë§ Th√¥ng tin ƒë·∫∑t h√†ng</h2>
<input id="name" placeholder="H·ªç t√™n">
<input id="phone" placeholder="SƒêT">
<input id="address" placeholder="ƒê·ªãa ch·ªâ">
<button class="btn-confirm" onclick="confirmOrder()">X√ÅC NH·∫¨N & THANH TO√ÅN</button>

<div id="qr">
<div class="qr-img-wrapper"><img id="qrImg" width="200"></div>
<p id="qrMoney"></p>
<p id="qrCode"></p>
</div>
</div>
</div>
</div>

<script>
const supabaseClient = supabase.createClient(
  "https://jviflefikptwitspugae.supabase.co",
  "sb_publishable_NR9e3NQFQ8H1QGBzHVHjDQ_DZ_n_MQd"
);

let products=[], cart=[];
const formatMoney=n=>n.toLocaleString("vi-VN")+" ‚Ç´";

/* LOAD PRODUCTS */
async function loadProducts(){
 const{data}=await supabaseClient.from("products").select("*").order("created_at",{ascending:false});
 products=data||[]; renderProducts();
}

function renderProducts(){
 document.getElementById("productList").innerHTML=products.map(p=>`
 <div class="product-item">
 <div><b>${p.name}</b><br><span style="color:#fbbf24">${formatMoney(p.price)}</span> | Kho: ${p.stock}</div>
 <button class="btn-add" onclick="addToCart(${p.id})">Th√™m</button>
 </div>`).join("");
}

/* CART */
function addToCart(id){
 const p=products.find(x=>x.id===id);
 if(!p||p.stock<=0)return alert("H·∫øt h√†ng");
 const i=cart.find(x=>x.id===id);
 if(i){if(i.qty>=p.stock)return alert("V∆∞·ª£t t·ªìn");i.qty++}
 else cart.push({...p,qty:1});
 renderCart();
}

function renderCart(){
 if(!cart.length){cartList.innerText="Ch∆∞a c√≥ s·∫£n ph·∫©m";totalArea.style.display="none";return}
 let t=0,h="<table>";
 cart.forEach(i=>{t+=i.price*i.qty;h+=`<tr><td>${i.name}</td><td>x${i.qty}</td><td>${formatMoney(i.price*i.qty)}</td></tr>`});
 cartList.innerHTML=h+"</table>";
 totalArea.innerText="T·ªïng: "+formatMoney(t);
 totalArea.style.display="block";
}

/* CONFIRM ORDER ‚Äì FIX QUAN TR·ªåNG */
async function confirmOrder(){
 if(!cart.length)return alert("Ch∆∞a c√≥ s·∫£n ph·∫©m");
 const name=nameInput.value.trim(),phone=phoneInput.value.trim(),address=addressInput.value.trim();
 if(!name||!phone||!address)return alert("Thi·∫øu th√¥ng tin");

 const order_code="DC247_"+Date.now();
 const total=cart.reduce((s,i)=>s+i.price*i.qty,0);

 /* 1. INSERT ORDERS */
 await supabaseClient.from("orders").insert({
   order_code, customer_name:name, phone, address, total
 });

 /* 2. INSERT ORDER_ITEMS (QUAN TR·ªåNG NH·∫§T) */
 await supabaseClient.from("order_items").insert(
   cart.map(i=>({
     order_code,
     product_id:i.id,
     quantity:i.qty
   }))
 );

 alert("ƒê·∫∑t h√†ng th√†nh c√¥ng!");
 cart=[]; renderCart();
}

window.onload=loadProducts;
</script>
</body>
</html>
