<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<title>Admin – Quản lý đơn hàng</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body {
  background:#0f172a; color:#e5e7eb;
  font-family:system-ui,sans-serif; padding:20px;
}
.card { background:#1e293b; padding:20px; border-radius:12px; }
table { width:100%; border-collapse:collapse; margin-top:15px; }
th,td { padding:10px; border-bottom:1px solid #334155; }
th { color:#fbbf24; font-size:13px; }
select {
  background:#020617; color:white;
  border:1px solid #334155;
  padding:6px; border-radius:6px;
}
</style>
</head>

<body>
<h1>⚙️ Quản lý đơn hàng</h1>

<div class="card">
<table>
<thead>
<tr>
  <th>Mã</th>
  <th>Khách</th>
  <th>SĐT</th>
  <th>Tổng</th>
  <th>Giao hàng</th>
  <th>Thanh toán</th>
  <th>Hình thức</th>
</tr>
</thead>
<tbody id="orders"></tbody>
</table>
</div>

<script>
/* ===== CONFIG ===== */
const supabaseClient = supabase.createClient(
  "https://jviflefikptwitspugae.supabase.co",
  "sb_publishable_NR9e3NQFQ8H1QGBzHVHjDQ_DZ_n_MQd"
);

/* ===== LOAD ORDERS ===== */
async function loadOrders() {
  const { data, error } = await supabaseClient
    .from("orders")
    .select("*")
    .order("order_code", { ascending:false });

  if (error) {
    alert(error.message);
    return;
  }

  document.getElementById("orders").innerHTML = data.map(o => `
<tr>
  <td>${o.order_code}</td>
  <td>${o.customer_name || "-"}</td>
  <td>${o.phone || "-"}</td>
  <td>${Number(o.total||0).toLocaleString()}đ</td>

  <td>
    <select onchange="updateOrder('${o.order_code}','delivery_status',this.value)">
      <option value="pending" ${o.delivery_status==='pending'?'selected':''}>Chưa giao</option>
      <option value="delivered" ${o.delivery_status==='delivered'?'selected':''}>Đã giao</option>
    </select>
  </td>

  <td>
    <select onchange="updateOrder('${o.order_code}','payment_status',this.value)">
      <option value="unpaid" ${o.payment_status==='unpaid'?'selected':''}>Chưa TT</option>
      <option value="paid" ${o.payment_status==='paid'?'selected':''}>Đã TT</option>
    </select>
  </td>

  <td>
    <select onchange="updateOrder('${o.order_code}','payment_method',this.value)">
      <option value="cash" ${o.payment_method==='cash'?'selected':''}>Tiền mặt</option>
      <option value="transfer" ${o.payment_method==='transfer'?'selected':''}>Chuyển khoản</option>
    </select>
  </td>
</tr>
`).join("");
}

/* ===== UPDATE ORDER (FIXED) ===== */
async function updateOrder(orderCode, field, value) {
  const { error } = await supabaseClient
    .from("orders")
    .update({ [field]: value })
    .eq("order_code", orderCode);

  if (error) {
    alert(error.message);
  }
}

/* ===== REALTIME ===== */
supabaseClient
  .channel("orders-realtime")
  .on(
    "postgres_changes",
    { event:"*", schema:"public", table:"orders" },
    () => loadOrders()
  )
  .subscribe();

/* ===== INIT ===== */
loadOrders();
</script>
</body>
</html>
